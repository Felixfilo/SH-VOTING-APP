{% extends 'base.html' %}

{% block title %}Admin Dashboard - Student Election{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="dashboard-header">
        <h1><i class="fas fa-tachometer-alt"></i> Election Administration</h1>
        <div class="header-actions">
            <a href="{% url 'admin_manage_students' %}" class="btn btn-primary">
                <i class="fas fa-user-graduate"></i> Manage Students
            </a>
            <a href="{% url 'election_settings' %}" class="btn btn-secondary">
                <i class="fas fa-cog"></i> Settings
            </a>
            {% if election_settings.results_published %}
                <a href="{% url 'results_view' %}" class="btn btn-info">
                    <i class="fas fa-chart-bar"></i> View Results
                </a>
                {% if pdf_available %}
                    <a href="{% url 'export_results_pdf' %}" class="btn btn-success">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </a>
                {% endif %}
            {% endif %}
        </div>
    </div>
    
    {% if election_settings %}
        <div class="election-status">
            <div class="status-card">
                <h3><i class="fas fa-info-circle"></i> {{ election_settings.name }}</h3>
                <div class="status-info">
                    <div class="status-item">
                        <span class="label">Status:</span>
                        <span class="value {% if election_settings.is_active %}active{% else %}inactive{% endif %}">
                            {% if election_settings.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                    {% if election_settings.voting_start %}
                        <div class="status-item">
                            <span class="label">Voting Start:</span>
                            <span class="value">{{ election_settings.voting_start }}</span>
                        </div>
                    {% endif %}
                    {% if election_settings.voting_end %}
                        <div class="status-item">
                            <span class="label">Voting End:</span>
                            <span class="value">{{ election_settings.voting_end }}</span>
                        </div>
                    {% endif %}
                    <div class="status-item">
                        <span class="label">Results Published:</span>
                        <span class="value {% if election_settings.results_published %}published{% else %}unpublished{% endif %}">
                            {% if election_settings.results_published %}Yes{% else %}No{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>{{ total_voters }}</h3>
                <p>Registered Voters</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-vote-yea"></i>
            </div>
            <div class="stat-content">
                <h3>{{ voted_count }}</h3>
                <p>Votes Cast</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="stat-content">
                <h3>{{ total_encrypted_votes }}</h3>
                <p>Encrypted Votes</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-user-tie"></i>
            </div>
            <div class="stat-content">
                <h3>{{ candidates.count }}</h3>
                <p>Candidates</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-crown"></i>
            </div>
            <div class="stat-content">
                <h3>{{ positions.count }}</h3>
                <p>Positions</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-content">
                <h3>{% if total_voters > 0 %}{% widthratio voted_count total_voters 100 %}%{% else %}0%{% endif %}</h3>
                <p>Turnout Rate</p>
            </div>
        </div>
    </div>

    <!-- Management Sections -->
    <div class="admin-sections">
        <!-- Quick Actions -->
        <div class="admin-section">
            <div class="section-header">
                <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
            </div>
            
            <div class="quick-actions-grid">
                <a href="{% url 'add_position' %}" class="quick-action-card">
                    <i class="fas fa-plus-circle"></i>
                    <span>Add Position</span>
                </a>
                <a href="{% url 'add_candidate' %}" class="quick-action-card">
                    <i class="fas fa-user-plus"></i>
                    <span>Add Candidate</span>
                </a>
                <a href="{% url 'audit_logs' %}" class="quick-action-card">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Audit Logs</span>
                </a>
                <a href="{% url 'election_settings' %}" class="quick-action-card">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
        </div>

        <!-- Positions Management -->
        <div class="admin-section">
            <div class="section-header">
                <h3><i class="fas fa-crown"></i> Manage Positions</h3>
                <a href="{% url 'add_position' %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus"></i> Add Position
                </a>
            </div>
            
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Candidates</th>
                            <th>Total Votes</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in vote_stats %}
                            <tr>
                                <td>
                                    <strong>{{ stat.position.name }}</strong>
                                    {% if stat.position.description %}
                                        <br><small class="text-muted">{{ stat.position.description|truncatewords:10 }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ stat.candidates.count }}</td>
                                <td>{{ stat.total_votes }}</td>
                                <td>
                                    <span class="status-badge {% if stat.position.is_active %}active{% else %}inactive{% endif %}">
                                        {% if stat.position.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{% url 'edit_position' stat.position.id %}" class="btn btn-sm btn-secondary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'delete_position' stat.position.id %}" 
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('Are you sure? This will delete all candidates in this position.')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No positions created yet.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Candidates Management -->
        <div class="admin-section">
            <div class="section-header">
                <h3><i class="fas fa-users"></i> Manage Candidates</h3>
                <a href="{% url 'add_candidate' %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus"></i> Add Candidate
                </a>
            </div>
            
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Candidate</th>
                            <th>Position</th>
                            <th>Votes</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for candidate in candidates %}
                            <tr>
                                <td>
                                    <div class="candidate-info">
                                        {% if candidate.photo %}
                                            <img src="{{ candidate.photo.url }}" alt="{{ candidate.name }}" class="table-photo">
                                        {% else %}
                                            <div class="table-photo-placeholder">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        {% endif %}
                                        <div>
                                            <strong>{{ candidate.name }}</strong>
                                            <br><small class="text-muted">{{ candidate.bio|truncatewords:8 }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ candidate.position.name }}</td>
                                <td>{{ candidate.vote_count }}</td>
                                <td>
                                    <span class="status-badge {% if candidate.is_active %}active{% else %}inactive{% endif %}">
                                        {% if candidate.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{% url 'edit_candidate' candidate.id %}" class="btn btn-sm btn-secondary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'delete_candidate' candidate.id %}" 
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('Are you sure you want to delete this candidate?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No candidates added yet.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Audit Logs -->
        <div class="admin-section">
            <div class="section-header">
                <h3><i class="fas fa-clipboard-list"></i> Recent Activity</h3>
                <a href="{% url 'audit_logs' %}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-eye"></i> View All Logs
                </a>
            </div>
            
            <div class="logs-container">
                {% for log in recent_logs %}
                    <div class="log-entry">
                        <div class="log-icon">
                            <i class="fas fa-{% if log.action == 'LOGIN' %}sign-in-alt{% elif log.action == 'LOGOUT' %}sign-out-alt{% elif log.action == 'VOTE' %}vote-yea{% elif log.action == 'PDF_EXPORT' %}file-pdf{% else %}cog{% endif %}"></i>
                        </div>
                        <div class="log-content">
                            <div class="log-action">{{ log.get_action_display }}</div>
                            <div class="log-description">{{ log.description }}</div>
                            <div class="log-meta">
                                <span class="log-user">{{ log.user.username|default:"System" }}</span>
                                <span class="log-time">{{ log.timestamp|timesince }} ago</span>
                                {% if log.ip_address %}
                                    <span class="log-ip">{{ log.ip_address }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="no-logs">
                        <i class="fas fa-info-circle"></i>
                        <p>No recent activity to display.</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
